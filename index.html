<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Flappy Bird - WebAudio Optimized</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <style>
    html,body { height:100%; margin:0; background:#272b30; }
    body { 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    canvas {
      display:block;
      image-rendering: optimizeSpeed;
      will-change: transform;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      touch-action: none;
    }
  </style>
</head>
<body>
<canvas id="game"></canvas>

<script>
/* ==== CONFIG ==== */
const GAME_W = 480, GAME_H = 640;
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

/* ==== ASSETS ==== */
const bgImg = new Image(); bgImg.src = './img/background.png';
const birdImg = new Image(); birdImg.src = './img/bird.png';
const groundImg = new Image(); groundImg.src = './img/ground.png';
const pipeImg = new Image(); pipeImg.src = './img/pipe.png';

/* ==== WEB AUDIO ==== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const sounds = {};
async function loadSound(name, url){
  const res = await fetch(url);
  const buf = await res.arrayBuffer();
  sounds[name] = await audioCtx.decodeAudioData(buf);
}
function playSound(name){
  if(!sounds[name]) return;
  const src = audioCtx.createBufferSource();
  src.buffer = sounds[name];
  src.connect(audioCtx.destination);
  src.start(0);
}
// preload
Promise.all([
  loadSound('flap','./sounds/flap.mp3'),
  loadSound('point','./sounds/point.mp3'),
  loadSound('hit','./sounds/hit.mp3'),
  loadSound('die','./sounds/die.mp3')
]);

/* ==== STATE ==== */
const state = {
  bird:null, pipes:[], frame:0, score:0,
  highScore:parseInt(localStorage.getItem('flappyHighScore')||'0',10),
  running:false, over:false, groundX:0
};
let groundH=0, devicePixelRatioFactor=1;

/* ==== LOAD ==== */
const assets=[bgImg,birdImg,groundImg,pipeImg]; let loaded=0;
assets.forEach(i => i.onload=()=>{ if(++loaded===assets.length) onAssetsLoaded(); });

function onAssetsLoaded(){
  groundH = groundImg.height;
  setupCanvas();
  initBird();
  drawIntro();
  window.addEventListener('resize', ()=>{ setupCanvas(); if(!state.running&&!state.over) drawIntro(); if(state.over) drawGameOver(); });
}

/* ==== Responsive ==== */
function setupCanvas(){
  devicePixelRatioFactor = window.devicePixelRatio || 1;
  canvas.width = GAME_W*devicePixelRatioFactor;
  canvas.height = GAME_H*devicePixelRatioFactor;
  ctx.setTransform(devicePixelRatioFactor,0,0,devicePixelRatioFactor,0,0);

  if(window.innerWidth<768){
    canvas.style.width=window.innerWidth+"px";
    canvas.style.height=window.innerHeight+"px";
  } else {
    const scale=Math.min(window.innerWidth/GAME_W, window.innerHeight/GAME_H);
    canvas.style.width=Math.round(GAME_W*scale)+"px";
    canvas.style.height=Math.round(GAME_H*scale)+"px";
  }
}

/* ==== Bird ==== */
function initBird(){
  const srcW = birdImg.width/3, srcH = birdImg.height;
  const scale=0.6;
  state.bird={x:60,y:160,srcW,srcH,scale,
    displayW:srcW*scale, displayH:srcH*scale,
    frameIndex:0,gravity:0.28,lift:-4.5,velocity:0};
}

/* ==== INPUT ==== */
canvas.addEventListener('pointerdown',()=>{
  audioCtx.resume(); // cần cho iOS
  if(!state.running && !state.over){ startGame(); }
  else if(state.running){
    state.bird.velocity=state.bird.lift;
    playSound('flap');
  } else if(state.over){ resetGame(); }
});
document.addEventListener('keydown',e=>{
  if(e.code==='Space'||e.code==='ArrowUp'){
    audioCtx.resume();
    if(!state.running && !state.over){ startGame(); }
    else if(state.running){
      state.bird.velocity=state.bird.lift;
      playSound('flap');
    } else if(state.over){ resetGame(); }
  }
});

/* ==== DRAW ==== */
function drawBackground(){ ctx.drawImage(bgImg,0,0,GAME_W,GAME_H-groundH); }
function drawGround(){
  const speed=2.2; state.groundX-=speed;
  if(state.groundX<=-groundImg.width) state.groundX=0;
  for(let x=state.groundX;x<GAME_W;x+=groundImg.width){
    ctx.drawImage(groundImg,Math.floor(x),GAME_H-groundH);
  }
}
function drawBird(){
  const b=state.bird;
  if(state.running && state.frame%8===0) b.frameIndex=(b.frameIndex+1)%3;
  const sx=b.frameIndex*b.srcW;
  const dw=b.displayW, dh=b.displayH, cx=b.x+dw/2, cy=b.y+dh/2;
  const angle=Math.max(-0.6,Math.min(1.2,b.velocity*0.12));
  ctx.save(); ctx.translate(cx,cy); ctx.rotate(angle);
  ctx.drawImage(birdImg,sx,0,b.srcW,b.srcH,-dw/2,-dh/2,dw,dh);
  ctx.restore();
}
function drawPipe(p){
  const w=p.width, topH=p.top, bottomH=(GAME_H-groundH)-p.bottom;
  ctx.save(); ctx.translate(p.x,p.top); ctx.scale(1,-1);
  ctx.drawImage(pipeImg,0,0,pipeImg.width,pipeImg.height,0,0,w,topH); ctx.restore();
  ctx.drawImage(pipeImg,0,0,pipeImg.width,pipeImg.height,p.x,p.bottom,w,bottomH);
}

/* ==== SCREENS ==== */
function drawIntro(){
  ctx.clearRect(0,0,GAME_W,GAME_H);
  drawBackground(); drawGround();
  ctx.fillStyle='black'; ctx.font='30px Arial'; ctx.textAlign='center';
  ctx.fillText('Flappy Bird',GAME_W/2,GAME_H/2-50);
  ctx.font='18px Arial';
  ctx.fillText('Bấm phím hoặc chạm để chơi',GAME_W/2,GAME_H/2);
  ctx.fillText('Điểm cao nhất: '+state.highScore,GAME_W/2,GAME_H/2+40);
  if(!state.running&&!state.over) requestAnimationFrame(drawIntro);
}
function drawGameOver(){
  ctx.clearRect(0,0,GAME_W,GAME_H);
  drawBackground(); state.pipes.forEach(p=>drawPipe(p)); drawGround(); drawBird();
  ctx.fillStyle='black'; ctx.font='28px Arial'; ctx.textAlign='center';
  ctx.fillText('GAME OVER',GAME_W/2,GAME_H/2-40);
  ctx.font='18px Arial';
  ctx.fillText('Điểm: '+state.score,GAME_W/2,GAME_H/2);
  ctx.fillText('Kỷ lục: '+state.highScore,GAME_W/2,GAME_H/2+30);
  ctx.fillText('Chạm hoặc Space để chơi lại',GAME_W/2,GAME_H/2+70);
}

/* ==== MAIN LOOP ==== */
function draw(){
  if(!state.running){ if(state.over) drawGameOver(); else drawIntro(); return; }
  ctx.clearRect(0,0,GAME_W,GAME_H);
  drawBackground();

  const b=state.bird;
  b.velocity+=b.gravity; b.y+=b.velocity; drawBird();

  if(state.frame%120===0){
    const baseGap=140, gap=Math.max(90,baseGap-Math.floor(state.score/5)*10);
    const maxTop=(GAME_H-groundH)-gap-40;
    const top=Math.random()*Math.max(0,maxTop)+20;
    state.pipes.push({x:GAME_W, top, bottom:top+gap, width:64});
  }
  for(const p of state.pipes){
    drawPipe(p); p.x-=2;
    if(b.x<p.x+p.width && b.x+b.displayW>p.x && (b.y<p.top||b.y+b.displayH>p.bottom)){
      playSound('hit'); state.running=false; state.over=true; drawGameOver(); return;
    }
    if(!p.scored && p.x+p.width/2<b.x+b.displayW/2){
      state.score++; p.scored=true; playSound('point');
    }
  }

  drawGround();
  if(b.y+b.displayH>GAME_H-groundH||b.y<0){
    playSound('hit'); state.running=false; state.over=true; drawGameOver(); return;
  }

  ctx.fillStyle='#000'; ctx.font='18px Arial';
  ctx.textAlign='left'; ctx.fillText('Điểm: '+state.score,10,24);
  ctx.textAlign='right'; ctx.fillText('Kỷ lục: '+state.highScore,GAME_W-10,24);

  state.frame++; requestAnimationFrame(draw);
}

/* ==== RESET / START ==== */
function resetGame(){
  if(state.score>state.highScore){
    state.highScore=state.score;
    localStorage.setItem('flappyHighScore',String(state.highScore));
  }
  state.pipes=[]; state.frame=0; state.score=0; state.groundX=0;
  state.running=false; state.over=false;
  const b=state.bird; if(b){ b.y=160; b.velocity=0; }
  drawIntro();
}
function startGame(){ resetGame(); state.running=true; draw(); }
</script>
</body>
</html>
